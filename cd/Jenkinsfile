pipeline {
    
    agent {
        label 'csaa-agent'
     }
  parameters {
        string(name: 'APP_MSG', defaultValue: 'Default Message from application', description: 'Message to pass to deployment?')
  
        choice(name: 'Environment', choices: ['csaa-dev', 'csaa-qa'], description: 'Pick environment to deploy your application')
  }    

    stages{
    
      stage("Deploy Application Image"){
           steps{
              container("jnlp"){
                 script{
                   openshift.withCluster() {
                     openshift.withProject("csaa-dev") {
                        // Deploy the development application.
                        // sh "oc project -q"
                         //def dcdev = openshift.selector('dc', "myapp").object();
                         openshift.selector("dc", "myapp").rollout().latest()
                        // def dc_version = dcdev.status.latestVersion;
                         //echo "version is ${dc_version}"

                   def latestDeploymentVersion = openshift.selector("dc","myapp").object().status.latestVersion
                    def rc = openshift.selector("rc", "myapp-${latestDeploymentVersion}")
                    timeout (time: 10, unit: 'MINUTES') {
                        rc.untilEach(1){
                            def rcMap = it.object()
                            return (rcMap.status.replicas.equals(rcMap.status.readyReplicas))
                        }
                    }                
                     
                     
                     
                     
                     }
    

           }
        }    
                  }

                }
                
            }
        } 

 }//end of pipeline

